<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:bal="http://schemas.microsoft.com/wix/BalExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Bundle Name="Arabic Poetry Management System"
          Version="1.0.0.0"
          Manufacturer="ArabicPoetry"
          UpgradeCode="{C6201EDE-1E15-4D22-8E9A-E2B9A0E40B07}"
          Compressed="yes">

    <BootstrapperApplicationRef Id="WixStandardBootstrapperApplication.RtfLicense">
      <bal:WixStandardBootstrapperApplication LicenseFile="license.rtf"
                                              SuppressOptionsUI="yes" />
    </BootstrapperApplicationRef>

    <!-- Skip DB provisioning only if a previous run completed successfully -->
    <util:RegistrySearch Root="HKLM"
                         Key="SYSTEM\CurrentControlSet\Services\ArabicPoetryMySQL"
                         Value="ArabicPoetryProvisioned"
                         Variable="ArabicPoetryMySqlProvisioned"
                         Result="exists" />

    <Chain>
      <!-- Application MSI (generated by jpackage) -->
      <MsiPackage Id="ArabicPoetryApp"
                  SourceFile="..\payloads\ArabicPoetry.msi"
                  DisplayName="Arabic Poetry Management System"
                  Vital="yes" />

      <!-- Provision local MySQL (from ZIP), apply schema, write installed config.properties -->
      <ExePackage Id="ProvisionLocalMySQL"
                  SourceFile="ProvisionMySqlRunner.exe"
                  DetectCondition="ArabicPoetryMySqlProvisioned"
                  InstallCommand="install"
                  UninstallCommand="uninstall"
                  Vital="yes"
                  PerMachine="yes"
                  >
        <Payload Id="ProvisionRunnerExe" SourceFile="ProvisionMySqlRunner.exe" />
        <Payload Id="SetupMysqlScript" SourceFile="..\setup-mysql.ps1" />
        <Payload Id="MysqlZip" SourceFile="..\payloads\mysql.zip" />
        <Payload Id="SchemaInstallSql" SourceFile="..\..\database\schema-install.sql" />
      </ExePackage>
    </Chain>
  </Bundle>
</Wix>
